######################################################################
# GitLab CI build script for the Kafka WebSocket Proxy                    #
######################################################################

######################################################################
# Shared environment variables for different stages of the CI pipeline #
######################################################################
variables:
  CI: "true"
  # Shared settings for the docker processes
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Setting specific folder for sbt-coursier to cache artifacts
  COURSIER_CACHE: "/root/cache/coursier"
  # Container scanning properties
  CS_MAJOR_VERSION: 2
  CI_APPLICATION_REPOSITORY: $CI_REGISTRY_IMAGE/server
  CI_APPLICATION_TAG: $CI_COMMIT_SHA
  ################################################################################
  # The flags defined below can be triggered by passing in a git push option to set
  # the ci.variable.
  # Example: git push -o ci.variable="TEST_DOCKER_BUILD=true" origin <branch>
  ################################################################################
  # Flag to trigger manual publishing of pages
  MANUAL_PUBLISH_PAGES: "false"
  # Flag to trigger a test-run of the docker image build
  TEST_DOCKER_BUILD: "false"

cache:
  untracked: true
  paths:
    - cache

stages:
  - commit
  - build
  - test
  - prepare-release
  - publish-docker
  - deploy
  - scan

include:
  - local: "/.gitlab/build_templates/gitlab-ci-release.yml"
    rules:
      - if: $WS_RELEASE_VERSION && $MANUAL_PUBLISH_PAGES != "true" && $TEST_DOCKER_BUILD != "true"
  - local: "/.gitlab/build_templates/gitlab-ci-scala-build.yml"
    rules:
      - if: $MANUAL_PUBLISH_PAGES != "true" && $TEST_DOCKER_BUILD != "true" && ($WS_RELEASE_VERSION == null || $WS_RELEASE_VERSION == "")
  - local: "/.gitlab/build_templates/gitlab-ci-scala-docker.yml"
    rules:
      - if: $MANUAL_PUBLISH_PAGES != "true" && ($WS_RELEASE_VERSION == null || $WS_RELEASE_VERSION == "")
  - local: "/.gitlab/build_templates/gitlab-ci-scala-pages.yml"
    rules:
      - if: $CI_COMMIT_TAG =~ /^v\d.*/ && $MANUAL_PUBLISH_PAGES != "true" && $TEST_DOCKER_BUILD != "true" && ($WS_RELEASE_VERSION == null || $WS_RELEASE_VERSION == "")
      - if: $MANUAL_PUBLISH_PAGES == "true" && $TEST_DOCKER_BUILD != "true" && ($WS_RELEASE_VERSION == null || $WS_RELEASE_VERSION == "")
  - local: "/.gitlab/build_templates/gitlab-ci-project-scanning.yml"
    rules:
      - if: $MANUAL_PUBLISH_PAGES != "true" && $TEST_DOCKER_BUILD != "true" && ($WS_RELEASE_VERSION == null || $WS_RELEASE_VERSION == "")